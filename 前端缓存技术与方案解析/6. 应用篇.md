## 前端应用中的 HTTP 缓存方案

![](https://github.com/WqhForGitHub/juejin-book/blob/main/%E5%89%8D%E7%AB%AF%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF%E4%B8%8E%E6%96%B9%E6%A1%88%E8%A7%A3%E6%9E%90/static/6/1.png?raw=true)

当我们访问首页时，浏览器率先加载的便是 HTML 文件，后续继续加载一些首页渲染需要以及公共的资源文件，当我们跳转页面时会异步加载下一个页面所需的资源，实现页面的组装及逻辑处理。

上图中我们观察仔细的读者会发现， **`刷新页面或再次访问时大部分资源都命中了强缓存，唯独率先加载的 HTML 资源走了协商缓存，这是为什么？`**

当你吃透了 HTTP 缓存的相关知识点后，原因其实很容易解释，因为像 **`JS、CSS`**  等资源经过像 **`webpack`** 这样的打包工具打包后可以自动生成 **`hash`** 文件名，每次部署到服务器上后发生变化的资源 hash 名会更新，浏览器会当作一个新的资源去向服务器请求，没有更新的资源便会优先读取浏览器缓存。

而 HTML 不同， **`其文件名不会改变`** ，我们期望浏览器每次加载时都应该向服务器询问是否更新，否则会出现新版本发布后浏览器读取缓存 HTML 文件导致页面空白报错（旧资源被删除）或应用没有更新（读取了旧资源）的问题。

根据 HTTP 缓存的规则最终我们便可以总结出如下缓存方案：

* **`频繁变动的资源，比如 HTML，采用协商缓存`**
* **`CSS、JS、图片资源等采用强缓存，使用 hash 命名`**

以上缓存方案也解释了在单页应用出现之前的一种现象，比如 **`jQuery`** 时代我们的资源文件一般通过在 HTML 中直接引入的方式来进行加载，同时会加上一段时间戳或者版本号代码：

```html
<script src="./js/demo.js?ver=1.0"></script>
```

因为浏览器会缓存之前的 JS、CSS 版本，通过上述添加类似于 hash 值的方式能够让浏览器加载我们最新的版本。

那么关于如何让 HTML 文件走协商缓存， **`前提得先让浏览器强缓存失效`**，可以设置如下服务器响应报头：

```bash
Cache-Control: max-age=0
Last-Modified: Sat, 04 Sep 2021 08:59:40 GMT
```



